<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>subscribe | Watchman</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="subscribe" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Since 1.6" />
<meta property="og:description" content="Since 1.6" />
<link rel="canonical" href="https://facebook.github.io/watchman/docs/cmd/subscribe.html" />
<meta property="og:url" content="https://facebook.github.io/watchman/docs/cmd/subscribe.html" />
<meta property="og:site_name" content="Watchman" />
<meta property="og:image" content="https://facebook.github.io/watchman/static/og_image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-03T15:40:25+00:00" />
<script type="application/ld+json">
{"headline":"subscribe","url":"https://facebook.github.io/watchman/docs/cmd/subscribe.html","dateModified":"2020-12-03T15:40:25+00:00","datePublished":"2020-12-03T15:40:25+00:00","description":"Since 1.6","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://facebook.github.io/watchman/static/logo.png"}},"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://facebook.github.io/watchman/docs/cmd/subscribe.html"},"image":"https://facebook.github.io/watchman/static/og_image.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" type="text/css" media="screen" href="/watchman/css/main.css">
  <link rel="icon" href="static/favicon.png" type="image/x-icon">

  <script async defer src="//cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react-with-addons.min.js"></script>
  <script async defer src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>

  
  <link type="application/atom+xml" rel="alternate" href="https://facebook.github.io/watchman/feed.xml" title="Watchman" />
</head>

  <body>    
    <div id="fixed_header" class="fixedHeaderContainer visible">
  <header>
    <a href="https://facebook.github.io/watchman/"><img src="/watchman/static/logo.png" /><h2>Watchman</h2></a>
    <div class="navigationWrapper navigationFull" id="flat_nav">
      <nav class="navigation">
        <ul>
          
          <li class="navItem navItemActive">
            <a href=/watchman/docs/install.html>Docs</a>
          </li>
          
          <li class="navItem ">
            <a href=/watchman/support.html>Support</a>
          </li>
          
          <li class="navItem ">
            <a href=http://github.com/facebook/watchman>GitHub</a>
          </li>
          
        </ul>
      </nav>
    </div>
    <div class="navigationWrapper navigationSlider" id="navigation_wrap"></div>
  </header>
  <script>
    var event = document.createEvent('Event');
    event.initEvent('slide', true, true);
    document.addEventListener('slide', function (e) {
      document.body.classList.toggle('sliderActive');
    }, false);
    var navData = [
      
      {
        href       : "/watchman/docs/install.html",
        text       : "Docs",
      },
      
      {
        href       : "/watchman/support.html",
        text       : "Support",
      },
      
      {
        href       : "http://github.com/facebook/watchman",
        text       : "GitHub",
      },
      
    ];
  </script>
  <script type="text/javascript">  
  window.addEventListener('load', function() {
    var Nav = React.createClass({displayName: "Nav",
      getInitialState: function() {
        return {
          currentPath: window.location.pathname,
          slideoutActive: false,
        };
      },
      getDefaultProps: function() {
        return {
          data: navData,
        }
      },
      handleClick: function(id) {
        this.setState({
          slideoutActive: false,
        });
        document.dispatchEvent(event);
      },
      handleSlide: function(id) {
        this.setState({
          slideoutActive: !this.state.slideoutActive,
        });
        document.dispatchEvent(event);
      },
      render: function() {
        var classes = React.addons.classSet({
          'navSlideout': true,
          'navSlideoutActive': this.state.slideoutActive,
        });
        var navClasses = React.addons.classSet({
          'slidingNav': true,
          'slidingNavActive': this.state.slideoutActive,
        });
        return (
          React.createElement("div", null, 
            React.createElement("div", {className: classes, onClick: this.handleSlide}, 
              React.createElement("i", {className: "fa fa-bars"})
            ), 
            React.createElement("nav", {className: navClasses}, 
              React.createElement("ul", null, 
                this.props.data.map(this.renderNavItems)
              )
            )
          )
        );
      },
      renderNavItems: function(child, index) {
        var classes = React.addons.classSet({
          'navItem': true,
          'navItemActive': this.state.currentPath === child.href,
        });
        return (
          React.createElement("li", {key: index, className: classes}, 
            React.createElement("a", {onClick: this.handleClick, href: child.href}, child.text)
          )
        );
      },
    });

    function render(navData) {
      React.render(
        React.createElement(Nav, {data: navData}),
        document.getElementById('navigation_wrap')
      );
    }
    render(navData);
  });
  </script>
</div>

    <div class="navPusher">
      <div class="mainContainer blogContainer postContainer">
  <div id="main_wrap" class="wrapper mainWrapper">
    <div>
</div>
<nav class='toc' id="doc_nav"></nav>
<script>
  var docnavData = [
    
    {
      group     : "Installation",
      items     : [
        
          
        {
          key : "/watchman/docs/install.html",
          title : "Installation",
          url : "/watchman/docs/install.html",
        },
        
          
        {
          key : "/watchman/docs/release-notes.html",
          title : "Release Notes",
          url : "/watchman/docs/release-notes.html",
        }
        
      ],
    },
    
    {
      group     : "Invocation",
      items     : [
        
          
        {
          key : "/watchman/docs/cli-options.html",
          title : "Command Line",
          url : "/watchman/docs/cli-options.html",
        },
        
          
        {
          key : "/watchman/docs/watchman-make.html",
          title : "watchman-make",
          url : "/watchman/docs/watchman-make.html",
        },
        
          
        {
          key : "/watchman/docs/watchman-wait.html",
          title : "watchman-wait",
          url : "/watchman/docs/watchman-wait.html",
        },
        
          
        {
          key : "/watchman/docs/watchman-replicate-subscription.html",
          title : "watchman-replicate-subscription",
          url : "/watchman/docs/watchman-replicate-subscription.html",
        },
        
          
        {
          key : "/watchman/docs/cppclient.html",
          title : "C++ Client",
          url : "/watchman/docs/cppclient.html",
        },
        
          
        {
          key : "/watchman/docs/nodejs.html",
          title : "NodeJS",
          url : "/watchman/docs/nodejs.html",
        },
        
          
        {
          key : "/watchman/docs/config.html",
          title : "Configuration Files",
          url : "/watchman/docs/config.html",
        },
        
          
        {
          key : "/watchman/docs/socket-interface.html",
          title : "Socket Interface",
          url : "/watchman/docs/socket-interface.html",
        }
        
      ],
    },
    
    {
      group     : "Compatibility",
      items     : [
        
          
        {
          key : "/watchman/docs/compatibility.html",
          title : "Compatibility Rules",
          url : "/watchman/docs/compatibility.html",
        },
        
          
        {
          key : "/watchman/docs/capabilities.html",
          title : "Capabilities",
          url : "/watchman/docs/capabilities.html",
        }
        
      ],
    },
    
    {
      group     : "Commands",
      items     : [
        
          
        {
          key : "/watchman/docs/cmd/clock.html",
          title : "clock",
          url : "/watchman/docs/cmd/clock.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/find.html",
          title : "find",
          url : "/watchman/docs/cmd/find.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/flush-subscriptions.html",
          title : "flush-subscriptions",
          url : "/watchman/docs/cmd/flush-subscriptions.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/get-config.html",
          title : "get-config",
          url : "/watchman/docs/cmd/get-config.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/get-sockname.html",
          title : "get-sockname",
          url : "/watchman/docs/cmd/get-sockname.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/list-capabilities.html",
          title : "list-capabilities",
          url : "/watchman/docs/cmd/list-capabilities.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/log.html",
          title : "log",
          url : "/watchman/docs/cmd/log.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/log-level.html",
          title : "log-level",
          url : "/watchman/docs/cmd/log-level.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/query.html",
          title : "query",
          url : "/watchman/docs/cmd/query.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/shutdown-server.html",
          title : "shutdown-server",
          url : "/watchman/docs/cmd/shutdown-server.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/since.html",
          title : "since",
          url : "/watchman/docs/cmd/since.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/state-enter.html",
          title : "state-enter",
          url : "/watchman/docs/cmd/state-enter.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/state-leave.html",
          title : "state-leave",
          url : "/watchman/docs/cmd/state-leave.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/subscribe.html",
          title : "subscribe",
          url : "/watchman/docs/cmd/subscribe.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/trigger.html",
          title : "trigger",
          url : "/watchman/docs/cmd/trigger.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/trigger-del.html",
          title : "trigger-del",
          url : "/watchman/docs/cmd/trigger-del.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/trigger-list.html",
          title : "trigger-list",
          url : "/watchman/docs/cmd/trigger-list.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/unsubscribe.html",
          title : "unsubscribe",
          url : "/watchman/docs/cmd/unsubscribe.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/version.html",
          title : "version",
          url : "/watchman/docs/cmd/version.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/watch.html",
          title : "watch",
          url : "/watchman/docs/cmd/watch.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/watch-del.html",
          title : "watch-del",
          url : "/watchman/docs/cmd/watch-del.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/watch-del-all.html",
          title : "watch-del-all",
          url : "/watchman/docs/cmd/watch-del-all.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/watch-list.html",
          title : "watch-list",
          url : "/watchman/docs/cmd/watch-list.html",
        },
        
          
        {
          key : "/watchman/docs/cmd/watch-project.html",
          title : "watch-project",
          url : "/watchman/docs/cmd/watch-project.html",
        }
        
      ],
    },
    
    {
      group     : "Queries",
      items     : [
        
          
        {
          key : "/watchman/docs/clockspec.html",
          title : "Clockspec",
          url : "/watchman/docs/clockspec.html",
        },
        
          
        {
          key : "/watchman/docs/file-query.html",
          title : "File Queries",
          url : "/watchman/docs/file-query.html",
        },
        
          
        {
          key : "/watchman/docs/simple-query.html",
          title : "Simple Pattern Syntax",
          url : "/watchman/docs/simple-query.html",
        },
        
          
        {
          key : "/watchman/docs/scm-query.html",
          title : "Source Control Aware Queries",
          url : "/watchman/docs/scm-query.html",
        }
        
      ],
    },
    
    {
      group     : "Expression Terms",
      items     : [
        
          
        {
          key : "/watchman/docs/expr/allof.html",
          title : "allof",
          url : "/watchman/docs/expr/allof.html",
        },
        
          
        {
          key : "/watchman/docs/expr/anyof.html",
          title : "anyof",
          url : "/watchman/docs/expr/anyof.html",
        },
        
          
        {
          key : "/watchman/docs/expr/dirname.html",
          title : "dirname & idirname",
          url : "/watchman/docs/expr/dirname.html",
        },
        
          
        {
          key : "/watchman/docs/expr/empty.html",
          title : "empty",
          url : "/watchman/docs/expr/empty.html",
        },
        
          
        {
          key : "/watchman/docs/expr/exists.html",
          title : "exists",
          url : "/watchman/docs/expr/exists.html",
        },
        
          
        {
          key : "/watchman/docs/expr/match.html",
          title : "match & imatch",
          url : "/watchman/docs/expr/match.html",
        },
        
          
        {
          key : "/watchman/docs/expr/name.html",
          title : "name & iname",
          url : "/watchman/docs/expr/name.html",
        },
        
          
        {
          key : "/watchman/docs/expr/not.html",
          title : "not",
          url : "/watchman/docs/expr/not.html",
        },
        
          
        {
          key : "/watchman/docs/expr/pcre.html",
          title : "pcre & ipcre",
          url : "/watchman/docs/expr/pcre.html",
        },
        
          
        {
          key : "/watchman/docs/expr/since.html",
          title : "since",
          url : "/watchman/docs/expr/since.html",
        },
        
          
        {
          key : "/watchman/docs/expr/size.html",
          title : "size",
          url : "/watchman/docs/expr/size.html",
        },
        
          
        {
          key : "/watchman/docs/expr/suffix.html",
          title : "suffix",
          url : "/watchman/docs/expr/suffix.html",
        },
        
          
        {
          key : "/watchman/docs/expr/type.html",
          title : "type",
          url : "/watchman/docs/expr/type.html",
        }
        
      ],
    },
    
    {
      group     : "Internals",
      items     : [
        
          
        {
          key : "/watchman/docs/bser.html",
          title : "BSER Binary Protocol",
          url : "/watchman/docs/bser.html",
        },
        
          
        {
          key : "/watchman/docs/casefolding.html",
          title : "Case-Insensitivity",
          url : "/watchman/docs/casefolding.html",
        },
        
          
        {
          key : "/watchman/contributing.html",
          title : "Contributing",
          url : "/watchman/contributing.html",
        },
        
          
        {
          key : "/watchman/docs/cookies.html",
          title : "Query Synchronization",
          url : "/watchman/docs/cookies.html",
        }
        
      ],
    },
    
    {
      group     : "Troubleshooting",
      items     : [
        
          
        {
          key : "/watchman/docs/troubleshooting.html",
          title : "Troubleshooting",
          url : "/watchman/docs/troubleshooting.html",
        }
        
      ],
    },
    
  ];
</script>
<script type="text/javascript">
window.addEventListener('load', function() {
  var DocNav = React.createClass({displayName: "DocNav",
    getInitialState: function() {
      return {
        toggleActive: false,
      };
    },
    getDefaultProps: function() {
      return {
        currentDoc: "subscribe",
        currentGroup: "Commands",
        data: docnavData,
      }
    },
    handleSlide: function(id) {
      this.setState({
        toggleActive: !this.state.toggleActive,
      });
    },
    render: function() {
      var classes = React.addons.classSet({
        'navToggle': true,
        'navToggleActive': this.state.toggleActive,
      });
      var navClasses = React.addons.classSet({
        'toggleNav': true,
        'toggleNavActive': this.state.toggleActive,
      });
      return (
        React.createElement("div", {className: navClasses},
          React.createElement("section", null,
            this.props.data.map(this.renderNavGroups)
          ),
          React.createElement("div", {className: classes, onClick: this.handleSlide}, React.createElement("i", {className: "fa fa-chevron-circle-down"}))
        )
      );
    },
    renderNavGroups: function(child, index) {
      var classes = React.addons.classSet({
        'navGroup': true,
        'navGroupActive': this.props.currentGroup === child.group,
      });
      return (
        React.createElement("div", {className: classes, key: index},
          React.createElement("h3", null, child.group),
          React.createElement("ul", null,
            child.items.map(this.renderNavItems)
          )
        )
      );
    },
    renderNavItems: function(child, index) {
      var itemClasses = React.addons.classSet({
        'navListItem': true,
        'navListItemActive': this.props.currentDoc === child.title,
      });
      var classes = React.addons.classSet({
        'navItem': true,
        'navItemActive': this.props.currentDoc === child.title,
      });
      return (
        React.createElement("li", {className: itemClasses, key: index}, React.createElement("a", {className: classes, href: child.url},  child.title))
      );
    },
  });

  function docNavRender(docnavData) {
    React.render(
      React.createElement(DocNav, {data: docnavData}),
      document.getElementById('doc_nav')
    );
  }
  docNavRender(docnavData);
});
</script>

    <div class="post">
  <header class="post-header">
    <h1 class="post-title">subscribe</h1>
  </header>

  <article class="post-content">
   
      <p><em>Since 1.6</em></p>

<p>Subscribes to changes against a specified root and requests that they be sent
to the client via its connection.  The updates will continue to be sent while
the connection is open.  If the connection is closed, the subscription is
implicitly removed.</p>

<p>This makes the most sense in an application connecting via the socket
interface, but you may also subscribe via the command line tool if you’re
interested in observing the changes for yourself:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>watchman <span class="nt">-j</span> <span class="nt">--server-encoding</span><span class="o">=</span>json <span class="nt">-p</span> <span class="o">&lt;&lt;-</span><span class="no">EOT</span><span class="sh">
["subscribe", "/path/to/root", "mysubscriptionname", {
  "expression": ["allof",
    ["type", "f"],
    ["not", "empty"],
    ["suffix", "php"]
  ],
  "fields": ["name"]
}]
</span><span class="no">EOT
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The example above registers a subscription against the specified root with the
name <code class="language-plaintext highlighter-rouge">mysubscriptionname</code>.</p>

<p>The response to a subscribe command looks like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w">   </span><span class="s2">"1.6"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"subscribe"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mysubscriptionname"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>When the subscription is first established, the
expression term is evaluated and if any files match, a subscription notification
packet is generated and sent, unilaterally to the client.</p>

<p>Then, each time a change is observed, and after the settle period has passed,
the expression is evaluated again.  If any files are matched, the server will
unilaterally send the query results to the client with a packet that looks like
this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.6"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clock"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c:1234:123"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"files"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"one.php"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"root"</span><span class="p">:</span><span class="w">  </span><span class="s2">"/path/being/watched"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"subscription"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mysubscriptionname"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The subscribe command object allows the client to specify a since parameter; if
present in the command, the initial set of subscription results will only
include files that changed since the specified clockspec, equivalent to using
the <code class="language-plaintext highlighter-rouge">query</code> command with the <code class="language-plaintext highlighter-rouge">since</code> generator.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="s2">"subscribe"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/path/to/root"</span><span class="p">,</span><span class="w"> </span><span class="s2">"myname"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"since"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c:1234:123"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"not"</span><span class="p">,</span><span class="w"> </span><span class="s2">"empty"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span><span class="w">
</span><span class="p">}]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The suggested mode of operation is for the client process to maintain its own
local copy of the last “clock” value and use that to establish the subscription
when it first connects.</p>

<h2 id="filesystem-settling">Filesystem Settling</h2>

<p>Prior to watchman version 3.2, the settling behavior was to hold subscription
notifications until the kernel notification stream was complete.</p>

<p>Starting in watchman version 3.2, after the notification stream is complete, if
the root appears to be a version control directory, subscription notifications
will be held until an outstanding version control operation is complete (at the
time of writing, this is based on the presence of either <code class="language-plaintext highlighter-rouge">.hg/wlock</code> or
<code class="language-plaintext highlighter-rouge">.git/index.lock</code>).  This behavior matches triggers and helps to avoid
performing transient work in response to files changing, for example, during a
rebase operation.</p>

<p>In some circumstances it is desirable for a client to observe the creation of
the control files at the start of a version control operation.  You may specify
that you want this behavior by passing the <code class="language-plaintext highlighter-rouge">defer_vcs</code> flag to your subscription
command invocation:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>watchman <span class="nt">-j</span> <span class="nt">-p</span> <span class="o">&lt;&lt;-</span><span class="no">EOT</span><span class="sh">
["subscribe", "/path/to/root", "mysubscriptionname", {
  "expression": ["allof",
    ["type", "f"],
    ["not", "empty"],
    ["suffix", "php"]
  ],
  "defer_vcs": false,
  "fields": ["name"]
}]
</span><span class="no">EOT
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="advanced-settling">Advanced Settling</h2>

<p><em>Since 4.4</em></p>

<p>In more complex integrations it is desirable to be able to have a watchman
aware application signal the beginning and end of some work that will
generate a lot of change notifications.  For example, Mercurial or Git could
communicate with watchman before and after updating the working copy.</p>

<p>Some applications will want to know that the update is in progress and
continue to process notifications.  Others may want to defer processing
the notifications until the update completes, and some may wish to drop
any notifications produced while the update was in progress.</p>

<p>Watchman subscriptions provide the mechanism for each of these use cases and
expose it via two new fields in the subscription object; <code class="language-plaintext highlighter-rouge">defer</code> and <code class="language-plaintext highlighter-rouge">drop</code> are
described below.</p>

<p>It can be difficult to mix <code class="language-plaintext highlighter-rouge">defer</code> and <code class="language-plaintext highlighter-rouge">drop</code> with multiple overlapping states
in the context of a given subscription stream as there is a single cursor to
track the subscription position.</p>

<p>If your application uses multiple overlapping states and wants to <code class="language-plaintext highlighter-rouge">defer</code> some
results and <code class="language-plaintext highlighter-rouge">drop</code> others, it is recommended that you use <code class="language-plaintext highlighter-rouge">drop</code> for all of
the states and then issues queries with <code class="language-plaintext highlighter-rouge">since</code> terms bounded by the <code class="language-plaintext highlighter-rouge">clock</code>
fields from the subscription state PDUs to ensure that it observes all of the
results of interest.</p>

<h3 id="defer">defer</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="s2">"subscribe"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/path/to/root"</span><span class="p">,</span><span class="w"> </span><span class="s2">"mysubscriptionname"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"defer"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"mystatename"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span><span class="w">
</span><span class="p">}]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">defer</code> field specifies a list of state names for which the subscriber
wishes to defer the notification stream.  When a watchman client signals that
a state has been entered via the
<a href="/watchman/docs/cmd/state-enter.html">state-enter</a> command, if the state name
matches any in the <code class="language-plaintext highlighter-rouge">defer</code> list then the subscription will emit a unilateral
subscription PDU like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"subscription"</span><span class="p">:</span><span class="w">  </span><span class="s2">"mysubscriptionname"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"root"</span><span class="p">:</span><span class="w">          </span><span class="s2">"/path/to/root"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"state-enter"</span><span class="p">:</span><span class="w">   </span><span class="s2">"mystatename"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clock"</span><span class="p">:</span><span class="w">         </span><span class="s2">"&lt;clock&gt;"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w">      </span><span class="err">&lt;metadata</span><span class="w"> </span><span class="err">from</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">state-enter</span><span class="w"> </span><span class="err">command&gt;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Watchman will then defer sending any subscription PDUs with <code class="language-plaintext highlighter-rouge">files</code> payloads
until the state is vacated either by a
<a href="/watchman/docs/cmd/state-leave.html">state-leave</a> command or by the client
that entered the state disconnecting from the watchman service.</p>

<p>Once the state is vacated, watchman will emit a unilateral subscription PDU
like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"subscription"</span><span class="p">:</span><span class="w">  </span><span class="s2">"mysubscriptionname"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"root"</span><span class="p">:</span><span class="w">          </span><span class="s2">"/path/to/root"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"state-leave"</span><span class="p">:</span><span class="w">   </span><span class="s2">"mystatename"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clock"</span><span class="p">:</span><span class="w">         </span><span class="s2">"&lt;clock&gt;"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w">      </span><span class="err">&lt;metadata</span><span class="w"> </span><span class="err">from</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">exit-state</span><span class="w"> </span><span class="err">command&gt;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The subscription stream will then be re-enabled and notifications received
since the corresponding <code class="language-plaintext highlighter-rouge">state-enter</code> will be delivered to clients.</p>

<h3 id="drop">drop</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="s2">"subscribe"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/path/to/root"</span><span class="p">,</span><span class="w"> </span><span class="s2">"mysubscriptionname"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"drop"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"mystatename"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span><span class="w">
</span><span class="p">}]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">drop</code> field specifies a list of state names for which the subscriber
wishes to discard the notification stream.  It works very much like <code class="language-plaintext highlighter-rouge">defer</code> as
described above, but when a state is vacated, the pending notification stream
is fast-forwarded to the clock of the <code class="language-plaintext highlighter-rouge">state-leave</code> command, effectively
suppressing any notifications that were generated between the <code class="language-plaintext highlighter-rouge">state-enter</code>
and the <code class="language-plaintext highlighter-rouge">state-leave</code> commands.</p>

<h2 id="source-control-aware-subscriptions">Source Control Aware Subscriptions</h2>

<p><em>Since 4.9</em></p>

<p><a href="/watchman/docs/scm-query.html">Read more about these here</a></p>


    
  </article>
</div>

  </div>
</div>


      <div class="footerContainer">
  <div id="footer_wrap" class="wrapper footerWrapper">
    <section id="fb_oss" class="fbOpenSourceFooter">
      <a href="https://code.facebook.com/projects/" target="_blank"><img src="/watchman/static/oss_logo.png" alt="Facebook Open Source" title="Facebook Open Source" /></a>
    </section>
  </div>
</div>
<script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = window.location.href.replace(window.location.hash, '') + "#" + id;
    anchor.innerHTML = "<i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  window.addEventListener('load', function() {
    var contentBlock = document.getElementsByClassName("post")[0] || document.getElementsByClassName("news")[0];
    if (!contentBlock) {
      return;
    }
    for (var level = 1; level <= 6; level++) {
      linkifyAnchors(level, contentBlock);
    }
  });
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44373548-13', 'auto');
  ga('send', 'pageview');
</script>
<script>
  window.addEventListener('load', function() {
    hljs.initHighlightingOnLoad();

    // Async load some styles
    function loadStyle(href) {
      var s = document.createElement('link');
      s.setAttribute('rel', 'stylesheet');
      s.setAttribute('href', href);
      s.setAttribute('type', 'text/css');
      document.getElementsByTagName('head')[0].appendChild(s);
    }
    loadStyle("//nuclide.io/static/fonts/332720/BC699FA675F9356E3.css");
    loadStyle("//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css");
    loadStyle("//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css");
  });
</script>

    </div>
  </body>

</html>
